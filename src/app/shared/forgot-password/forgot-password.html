<div class="container">
  <mat-card class="reset-card">
    <mat-card-title>
      @if (currentStep() === 1) {
        <span>Forgot Password</span>
      } @else {
        <span>Reset Password</span>
      }
    </mat-card-title>
    
    <mat-card-content [formGroup]="resetForm">

      @if (currentStep() === 1) {
        <div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" placeholder="Enter your email" required>
            @if (resetForm.get('email')?.hasError('required')) {
              <mat-error>Email is required</mat-error>
            }
            @if (resetForm.get('email')?.hasError('email')) {
              <mat-error>Not a valid email</mat-error>
            }
          </mat-form-field>

          <div class="form-group radio-group">
            <label class="radio-group-label">Verification Method</label>
            <mat-radio-group formControlName="verifyEmail" name="verifyEmail" class="radio-options">
              <mat-radio-button [value]="true">With Email Verification</mat-radio-button>
              <mat-radio-button [value]="false">Without Email Verification (Log OTP)</mat-radio-button>
            </mat-radio-group>
          </div>
        </div>
      }

      @if (currentStep() === 2) {
        <div>
          <div class="email-display">
            Verifying for: <strong>{{ userEmail() }}</strong>
            <button mat-icon-button (click)="backToEmail()" class="edit-email-btn" matTooltip="Change Email">
              <mat-icon>edit</mat-icon>
            </button>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>OTP Code</mat-label>
            <input matInput formControlName="otp" placeholder="Enter 6-digit OTP" maxlength="6">
            @if (resetForm.get('otp')?.hasError('required')) {
              <mat-error>OTP is required</mat-error>
            }
            @if (resetForm.get('otp')?.hasError('pattern')) {
              <mat-error>OTP must be 6 digits</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>New Password</mat-label>
            <input matInput formControlName="newPassword" [type]="hidePassword() ? 'password' : 'text'" required>
            <button mat-icon-button matSuffix (click)="togglePasswordVisibility()" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hidePassword()">
              <mat-icon>{{hidePassword() ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            @if (resetForm.get('newPassword')?.hasError('required')) {
              <mat-error>New password is required</mat-error>
            }
            @if (resetForm.get('newPassword')?.hasError('minlength')) {
              <mat-error>Must be at least 8 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirm New Password</mat-label>
            <input matInput formControlName="confirmPassword" [type]="hideConfirmPassword() ? 'password' : 'text'" required>
            <button mat-icon-button matSuffix (click)="toggleConfirmPasswordVisibility()" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hideConfirmPassword()">
              <mat-icon>{{hideConfirmPassword() ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            @if (resetForm.get('confirmPassword')?.hasError('required')) {
              <mat-error>Please confirm your password</mat-error>
            }
            @if (resetForm.hasError('passwordMismatch') && resetForm.get('confirmPassword')?.touched) {
              <mat-error>Passwords do not match</mat-error>
            }
          </mat-form-field>
        </div>
      }

    </mat-card-content>

    <mat-card-actions class="card-actions">
      @if (!isLoading()) {
        <div>
          @if (currentStep() === 1) {
            <button mat-flat-button color="primary" class="full-width" 
                    (click)="requestOtp()" [disabled]="resetForm.get('email')?.invalid || resetForm.get('verifyEmail')?.invalid">
              Send OTP
            </button>
          }
          @if (currentStep() === 2) {
            <button mat-flat-button color="primary" class="full-width" 
                    (click)="resetPassword()" [disabled]="resetForm.invalid">
              Reset Password
            </button>
          }
        </div>
      } @else {
        <mat-spinner [diameter]="30"></mat-spinner>
      }
    </mat-card-actions>

    @if (currentStep() === 1) {
      <div class="login-link">
        <a routerLink="/login">Back to Login</a>
      </div>
    }
  </mat-card>
</div>